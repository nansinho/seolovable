# SEOLovable - Configuration Nginx pour Prerender
# À ajouter dans votre bloc server {} pour wpgrok.com
# 
# Cette config détecte les bots (Google, Bing, ChatGPT, etc.) 
# et les redirige vers votre service de prerendering

# Variables pour la config
map $http_user_agent $is_bot {
    default 0;
    
    # Bots Google
    ~*googlebot 1;
    ~*google-inspectiontool 1;
    ~*google-extended 1;
    ~*google-safety 1;
    ~*adsbot-google 1;
    ~*mediapartners-google 1;
    ~*feedfetcher-google 1;
    
    # Autres moteurs de recherche
    ~*bingbot 1;
    ~*yandex 1;
    ~*baiduspider 1;
    ~*duckduckbot 1;
    ~*slurp 1;
    ~*sogou 1;
    ~*exabot 1;
    ~*facebot 1;
    ~*ia_archiver 1;
    
    # Bots IA
    ~*chatgpt-user 1;
    ~*gptbot 1;
    ~*claude-web 1;
    ~*anthropic-ai 1;
    ~*perplexitybot 1;
    ~*cohere-ai 1;
    ~*meta-externalagent 1;
    
    # Réseaux sociaux
    ~*twitterbot 1;
    ~*facebookexternalhit 1;
    ~*linkedinbot 1;
    ~*pinterest 1;
    ~*slackbot 1;
    ~*telegrambot 1;
    ~*whatsapp 1;
    ~*discordbot 1;
    
    # Autres crawlers
    ~*applebot 1;
    ~*semrushbot 1;
    ~*ahrefsbot 1;
    ~*mj12bot 1;
    ~*dotbot 1;
    ~*rogerbot 1;
    ~*embedly 1;
    ~*quora\ link\ preview 1;
    ~*outbrain 1;
    ~*w3c_validator 1;
}

# Extensions à ignorer (fichiers statiques)
map $uri $is_static_file {
    default 0;
    ~*\.(js|css|xml|less|png|jpg|jpeg|gif|pdf|doc|txt|ico|rss|zip|mp3|rar|exe|wmv|avi|ppt|mpg|mpeg|tif|wav|mov|psd|ai|xls|mp4|m4a|swf|dat|dmg|iso|flv|m4v|torrent|ttf|woff|woff2|svg|eot|webp|webm)$ 1;
}

server {
    listen 80;
    listen 443 ssl;
    server_name wpgrok.com www.wpgrok.com;
    
    # Vos certificats SSL (ajustez les chemins)
    # ssl_certificate /path/to/cert.pem;
    # ssl_certificate_key /path/to/key.pem;
    
    # Votre token prerender (à remplacer)
    set $prerender_token "VOTRE_TOKEN_ICI";
    
    location / {
        # Si c'est un bot ET pas un fichier statique
        if ($is_bot = 1) {
            set $prerender_test "A";
        }
        if ($is_static_file = 0) {
            set $prerender_test "${prerender_test}B";
        }
        
        # Condition combinée: bot + pas de fichier statique
        if ($prerender_test = "AB") {
            # Encode l'URL complète
            set $prerender_url "https://prerender.seolovable.cloud/https://$host$request_uri";
            
            # Redirige vers le service prerender
            proxy_pass $prerender_url;
            proxy_set_header X-Prerender-Token $prerender_token;
            proxy_set_header X-Original-User-Agent $http_user_agent;
            proxy_set_header Host prerender.seolovable.cloud;
            
            # Headers pour le tracking
            add_header X-Prerender-Status "rendered" always;
            break;
        }
        
        # Sinon, proxy normal vers votre app
        # Ajustez le port selon votre configuration Coolify
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
